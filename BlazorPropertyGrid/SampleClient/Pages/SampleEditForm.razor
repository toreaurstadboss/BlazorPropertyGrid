@page "/sampleeditform"
@using Microsoft.AspNetCore.Components.Forms
@using BlazorPropertyGridComponents.Components
@using BlazorSampleClient.Models
@using System.Reflection
@inject IJSRuntime JsRunTime

<h3 class="mb-4">Customer Details</h3>

<div class="row">
    <div class="col-md-6"> <!-- Edit Form is in the left column -->
        <h4 class="mb-3">Edit Form</h4>
        <EditForm Model="@exampleModel" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="enrollement date">Enrollement date</label><br />                
                <InputDate Type="InputDateType.DateTimeLocal" id="EnrollementDate" placeholder="Time of enrollement" @bind-Value="exampleModel.EnrollementDate" />
                <ValidationMessage For="@(() => exampleModel.EnrollementDate)" />
            </div>

            <div class="form-group">
                <label for="name">Name</label><br />
                <InputText id="Name" placeholder="State your full name" @bind-Value="exampleModel.Name" />
                <ValidationMessage For="@(() => exampleModel.Name)" />
            </div>

            <div class="form-group">
                <label for="age">Age</label><br />
                <InputNumber id="Age" placeholder="Your age" @bind-Value="exampleModel.Age" />
                <ValidationMessage For="@(() => exampleModel.Age)" />
            </div>

            <div class="form-group">
                <label for="gender">MemberShip Type</label><br />
                <InputSelect id="CustomerInfo_MemberShipType" placeholder="Your membership type" @bind-Value="exampleModel.CustomerInfo.MemberShipType">
                    @foreach (var memberShipType in Enum.GetValues(typeof(MemberShipType)))
                    {
                        <option value="@memberShipType">@memberShipType</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => exampleModel.CustomerInfo.MemberShipType)" />
            </div>

            <div class="form-group">
                <label for="VIP">VIP?</label><br />
                <InputCheckbox id="CustomerInfo_IsVIP" placeholder="Is VIP" @bind-Value="@exampleModel.CustomerInfo.IsVIP" />
                <ValidationMessage For="@(() => exampleModel.CustomerInfo.IsVIP)" />
            </div>

            <div class="form-group">
                <label for="city">City</label><br />
                <InputText id="City" placeholder="Your home city" @bind-Value="exampleModel.City" />
                <ValidationMessage For="@(() => exampleModel.City)" />
            </div>

            <div class="form-group">
                <label for="zipcode">Zipcode</label><br />
                <InputNumber id="Address_Zipcode" placeholder="Address zipcode" @bind-Value="exampleModel.Address.Zipcode" />
                <ValidationMessage For="@(() => exampleModel.Address.Zipcode)" />
            </div>

            <div class="form-group">
                <label for="State">State</label><br />
                <InputText id="Address_State" placeholder="State (max three letters)" @bind-Value="exampleModel.Address.State" />
                <ValidationMessage For="@(() => exampleModel.Address.State)" />
            </div>

            <div class="form-group">
                <label for="pobox">Post box</label><br />
                <InputText id="Address_AddressDetails_Box" placeholder="P/O Box" @bind-Value="exampleModel.Address.AddressDetails.Box" />
                <ValidationMessage For="@(() => exampleModel.Address.AddressDetails.Box)" />
            </div>

            <div class="form-group">
                <label for="streetAddress">Street address</label><br />
                <InputText id="Address_AddressDetails_StreetAddress" placeholder="Street address" @bind-Value="exampleModel.Address.AddressDetails.StreetAddress" />
                <ValidationMessage For="@(() => exampleModel.Address.AddressDetails.StreetAddress)" />
            </div>

            <button type="submit" class="btn btn-primary">Submit</button>

        </EditForm>
    </div>
    <div class="col-md-6"> <!-- Proprety grid is shown in the right column-->
        <h4 class="mb-3">Property Grid Component Demo</h4>
        <PropertyGridComponent 
            PropertySetValueCallback="OnPropertyValueSet" 
            ObjectTitle="Property grid - Edit form for : 'Customer Details'" 
            DataContext="@exampleModel"></PropertyGridComponent>
    </div>
</div>



@code {
    private void OnPropertyValueSet(PropertyChangedInfoNotificationInfoPayload pi)
    {
        if (pi == null)
            return;

        // Update the model property directly via reflection so Blazor re-renders correctly
        SetPropertyByPath(exampleModel, pi.FullPropertyPath, pi.Value, pi.ValueType);
        StateHasChanged();
    }

    private void SetPropertyByPath(object target, string propertyPath, object value, string valueType)
    {
        if (target == null || string.IsNullOrEmpty(propertyPath))
            return;

        var parts = propertyPath.Split('.');
        var current = target;

        // Navigate to the parent object
        for (int i = 0; i < parts.Length - 1; i++)
        {
            var prop = current.GetType().GetProperty(parts[i]);
            if (prop == null) return;
            current = prop.GetValue(current);
            if (current == null) return;
        }

        // Set the final property
        var finalProp = current.GetType().GetProperty(parts[^1]);
        if (finalProp == null) return;

        try
        {
            object convertedValue = value;

            if (finalProp.PropertyType.IsEnum && value != null)
            {
                var valStr = value.ToString();
                if (int.TryParse(valStr, out int intVal))
                    convertedValue = Enum.ToObject(finalProp.PropertyType, intVal);
                else
                    convertedValue = Enum.Parse(finalProp.PropertyType, valStr, ignoreCase: true);
            }
            else if (finalProp.PropertyType == typeof(bool) && value != null)
            {
                convertedValue = Convert.ToBoolean(value);
            }
            else if (value != null && finalProp.PropertyType != typeof(string))
            {
                convertedValue = Convert.ChangeType(value, finalProp.PropertyType);
            }

            finalProp.SetValue(current, convertedValue);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to set {propertyPath}: {ex.Message}");
        }
    }

    private CustomerModel exampleModel = new CustomerModel
    {
        Address = new AddressInfo
        {
            Zipcode = 7045,
            AddressDetails = new AddressInfoDetails
            {
                Box = "PO Box 123"
            }
        }
    };

    private void HandleValidSubmit()
    {

    }

}
